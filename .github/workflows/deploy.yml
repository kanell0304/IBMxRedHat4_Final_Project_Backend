name: Deploy to AWS

on:
  push:
    branches: [main]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: teamproject-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. AWS ìê²© ì¦ëª… ì„¤ì •
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 3. ëª¨ë¸ íŒŒì¼ì´ ìˆìœ¼ë©´ S3ì— ì—…ë¡œë“œ
      - name: Upload models to S3
        run: |
          echo "ğŸ“¤ ëª¨ë¸ íŒŒì¼ S3 ì—…ë¡œë“œ í™•ì¸ ì¤‘..."
          
          if [ -d "app/ml_models" ]; then
            for file in app/ml_models/*.pkl; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                echo "  ì—…ë¡œë“œ: $filename"
                aws s3 cp "$file" "s3://${{ secrets.S3_MODEL_BUCKET }}/$filename"
              fi
            done
            echo "âœ… S3 ì—…ë¡œë“œ ì™„ë£Œ"
          else
            echo "âš ï¸ ml_models í´ë” ì—†ìŒ (ìŠ¤í‚µ)"
          fi

      # 4. ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 5. Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "ğŸ“¤ ECRì— í‘¸ì‹œ ì¤‘..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "âœ… Docker ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ"
          echo "IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY:latest" >> $GITHUB_ENV

      # 6. EC2ì— ë°°í¬
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ EC2 ë°°í¬ ì‹œì‘..."
            
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            export AWS_REGION=${{ env.AWS_REGION }}
            export ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}
            export ECR_REPOSITORY=${{ env.ECR_REPOSITORY }}
            export S3_MODEL_BUCKET=${{ secrets.S3_MODEL_BUCKET }}
            
            # ECR ë¡œê·¸ì¸
            aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
            docker stop teamproject-backend 2>/dev/null || true
            docker rm teamproject-backend 2>/dev/null || true
            
            # ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -af
            
            # ìƒˆ ì´ë¯¸ì§€ í’€
            docker pull $ECR_REGISTRY/$ECR_REPOSITORY:latest
            
            # ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            docker run -d \
              --name teamproject-backend \
              --restart unless-stopped \
              -p 8081:8081 \
              -e S3_MODEL_BUCKET=$S3_MODEL_BUCKET \
              -e S3_MODEL_PREFIX= \
              -e AWS_REGION=$AWS_REGION \
              -e DB_HOST=${{ secrets.DB_HOST }} \
              -e DB_PORT=${{ secrets.DB_PORT }} \
              -e DB_NAME=${{ secrets.DB_NAME }} \
              -e DB_USER=${{ secrets.DB_USER }} \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              $ECR_REGISTRY/$ECR_REPOSITORY:latest
            
            # ìƒíƒœ í™•ì¸
            sleep 10
            docker ps
            
            # í—¬ìŠ¤ ì²´í¬
            curl -f http://localhost:8081/health || echo "âš ï¸ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨"
            
            echo "âœ… ë°°í¬ ì™„ë£Œ!"

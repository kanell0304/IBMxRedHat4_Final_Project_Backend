name: Deploy to AWS

on:
  push:
    branches: [main]
  workflow_dispatch:  # ÏàòÎèô Ïã§Ìñâ Í∞ÄÎä•

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: teamproject-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. AWS ÏûêÍ≤© Ï¶ùÎ™Ö ÏÑ§Ï†ï
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 3. Î™®Îç∏ ÌååÏùºÏù¥ ÏûàÏúºÎ©¥ S3Ïóê ÏóÖÎ°úÎìú
      - name: Upload models to S3
        run: |
          echo "üì§ Î™®Îç∏ ÌååÏùº S3 ÏóÖÎ°úÎìú ÌôïÏù∏ Ï§ë..."
          
          if [ -d "app/ml_models" ]; then
            for file in app/ml_models/*.pkl; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                echo "  ÏóÖÎ°úÎìú: $filename"
                aws s3 cp "$file" "s3://${{ secrets.S3_MODEL_BUCKET }}/$filename"
              fi
            done
            echo "‚úÖ S3 ÏóÖÎ°úÎìú ÏôÑÎ£å"
          else
            echo "‚ö†Ô∏è ml_models Ìè¥Îçî ÏóÜÏùå (Ïä§ÌÇµ)"
          fi

      # 4. ECR Î°úÍ∑∏Ïù∏
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 5. Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú & Ìë∏Ïãú
      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "üê≥ Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Ï§ë..."
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "üì§ ECRÏóê Ìë∏Ïãú Ï§ë..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "‚úÖ Docker Ïù¥ÎØ∏ÏßÄ Ìë∏Ïãú ÏôÑÎ£å"
          echo "IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY:latest" >> $GITHUB_ENV

      # 6. EC2Ïóê Î∞∞Ìè¨
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "üöÄ EC2 Î∞∞Ìè¨ ÏãúÏûë..."
            
            # ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï
            export AWS_REGION=${{ env.AWS_REGION }}
            export ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}
            export ECR_REPOSITORY=${{ env.ECR_REPOSITORY }}
            export S3_MODEL_BUCKET=${{ secrets.S3_MODEL_BUCKET }}
            
            # ECR Î°úÍ∑∏Ïù∏
            aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
            
            # Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Ï§ëÏßÄ Î∞è ÏÇ≠Ï†ú
            docker stop teamproject-backend 2>/dev/null || true
            docker rm teamproject-backend 2>/dev/null || true
            
            # Ïò§ÎûòÎêú Ïù¥ÎØ∏ÏßÄ Ï†ïÎ¶¨
            docker image prune -af
            
            # ÏÉà Ïù¥ÎØ∏ÏßÄ ÌíÄ
            docker pull $ECR_REGISTRY/$ECR_REPOSITORY:latest
            
            # Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ
            docker run -d \
              --name teamproject-backend \
              --restart unless-stopped \
              -p 8081:8081 \
              -e S3_MODEL_BUCKET=$S3_MODEL_BUCKET \
              -e S3_MODEL_PREFIX= \
              -e AWS_REGION=ap-northeast-2 \
              -e DB_HOST=${{ secrets.DB_HOST }} \
              -e DB_PORT=${{ secrets.DB_PORT }} \
              -e DB_NAME=${{ secrets.DB_NAME }} \
              -e DB_USER=${{ secrets.DB_USER }} \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -e ALLOWED_ORIGINS="${{ secrets.ALLOWED_ORIGINS }}" \
              -e SECRET_KEY="${{ secrets.SECRET_KEY }}" \
              -e JWT_ALGORITHM=HS256 \
              -e ACCESS_TOKEN_EXPIRE=6000 \
              -e REFRESH_TOKEN_EXPIRE=604800 \
              -e GMAIL_USER="${{ secrets.GMAIL_USER }}" \
              -e GMAIL_APP_PASSWORD="${{ secrets.GMAIL_APP_PASSWORD }}" \
              -e FRONTEND_URL="${{ secrets.FRONTEND_URL }}" \
              -e KAKAO_CLIENT_ID="${{ secrets.KAKAO_CLIENT_ID }}" \
              -e KAKAO_CLIENT_SECRET="" \
              -e KAKAO_REDIRECT_URI="${{ secrets.KAKAO_REDIRECT_URI }}" \
              -e GOOGLE_CLOUD_PROJECT_ID=spageti-stt \
              -e GOOGLE_APPLICATION_CREDENTIALS=./spageti-stt-de1456d6a2c0.json \
              -e LLM_PROVIDER=openai \
              -e OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
              -e OPENAI_MODEL=gpt-4o-mini \
              $ECR_REGISTRY/$ECR_REPOSITORY:latest
            
            # ÏÉÅÌÉú ÌôïÏù∏
            sleep 10
            docker ps
            
            # Ìó¨Ïä§ Ï≤¥ÌÅ¨
            curl -f http://localhost:8081/health || echo "‚ö†Ô∏è Ìó¨Ïä§ Ï≤¥ÌÅ¨ Ïã§Ìå®"
            
            echo "‚úÖ Î∞∞Ìè¨ ÏôÑÎ£å!"

import json
import numpy as np
import torch
from transformers import AutoModelForSequenceClassification, AutoTokenizer

# 모델/토크나이저 로드 (CPU 사용)
model_dir = "I_P_BERT"  # 모델 파일이 있는 경로
device = torch.device("cpu")
tokenizer = AutoTokenizer.from_pretrained(model_dir)
model = AutoModelForSequenceClassification.from_pretrained(model_dir).to(device)
model.eval()

def _label_at(i: int) -> str:
  # id2label 키가 문자열/정수 어떤 형태든 대응
  return (
    model.config.id2label.get(str(i))
    or model.config.id2label.get(i)
    or f"LABEL_{i}"
  )

label_names = [_label_at(i) for i in range(model.config.num_labels)]

# 예시 STT 응답 (실제 실행 시에는 stt_result를 외부에서 주입)
stt_result = {"results":[{"alternatives":[{"transcript":"스파게티 팀 과제를 하고 있는데요음 어","confidence":0.83671325,"words":[{"endOffset":"2.300s","word":"▁","confidence":0.87048674},{"startOffset":"2.300s","endOffset":"2.300s","word":"스"},{"startOffset":"2.300s","endOffset":"2.500s","word":"파","confidence":0.87048674},{"startOffset":"2.500s","endOffset":"2.600s","word":"게","confidence":0.87048674},{"startOffset":"2.600s","endOffset":"2.700s","word":"티","confidence":0.87048674},{"startOffset":"2.700s","endOffset":"2.900s","word":"▁","confidence":0.87048674},{"startOffset":"2.900s","endOffset":"3.100s","word":"팀","confidence":0.87048674},{"startOffset":"3.100s","endOffset":"4.100s","word":"▁","confidence":0.87048674},{"startOffset":"4.100s","endOffset":"4.100s","word":"과"},{"startOffset":"4.100s","endOffset":"4.300s","word":"제","confidence":0.87048674},{"startOffset":"4.300s","endOffset":"4.400s","word":"를","confidence":0.87048674},{"startOffset":"4.400s","endOffset":"4.600s","word":"▁","confidence":0.87048674},{"startOffset":"4.600s","endOffset":"4.600s","word":"하고"},{"startOffset":"4.600s","endOffset":"4.800s","word":"▁있는데","confidence":0.87048674},{"startOffset":"4.800s","endOffset":"5s","word":"요","confidence":0.87048674},{"startOffset":"5s","endOffset":"6.600s","word":"▁","confidence":0.7741064},{"startOffset":"6.600s","endOffset":"6.600s","word":"음"},{"startOffset":"6.600s","endOffset":"8.300s","word":"▁어","confidence":0.69997275}]},{"transcript":"스파게티 팀 과제를 하고 있는데요음","confidence":0.86406136}],"resultEndOffset":"9s","languageCode":"ko-kr"},{"alternatives":[{"transcript":" 지금 클로바 스피치가 아주 인식을 잘하는 걸로 보여지고요","confidence":0.8559207,"words":[{"startOffset":"10s","endOffset":"10.300s","word":"▁지금","confidence":0.87048674},{"startOffset":"10.300s","endOffset":"10.600s","word":"▁","confidence":0.87048674},{"startOffset":"10.600s","endOffset":"10.700s","word":"클","confidence":0.87048674},{"startOffset":"10.700s","endOffset":"10.900s","word":"로","confidence":0.87048674},{"startOffset":"10.900s","endOffset":"10.900s","word":"바","confidence":0.87048674},{"startOffset":"10.900s","endOffset":"11.500s","word":"▁","confidence":0.87048674},{"startOffset":"11.500s","endOffset":"11.600s","word":"스","confidence":0.87048674},{"startOffset":"11.600s","endOffset":"11.700s","word":"피","confidence":0.87048674},{"startOffset":"11.700s","endOffset":"11.800s","word":"치","confidence":0.87048674},{"startOffset":"11.800s","endOffset":"11.900s","word":"가","confidence":0.87048674},{"startOffset":"11.900s","endOffset":"12.600s","word":"▁아","confidence":0.87048674},{"startOffset":"12.600s","endOffset":"12.800s","word":"주","confidence":0.87048674},{"startOffset":"12.800s","endOffset":"13.100s","word":"▁","confidence":0.87048674},{"startOffset":"13.100s","endOffset":"13.100s","word":"인"},{"startOffset":"13.100s","endOffset":"13.300s","word":"식","confidence":0.87048674},{"startOffset":"13.300s","endOffset":"13.300s","word":"을","confidence":0.87048674},{"startOffset":"13.300s","endOffset":"13.600s","word":"▁잘","confidence":0.87048674},{"startOffset":"13.600s","endOffset":"13.800s","word":"하는","confidence":0.7340321},{"startOffset":"13.800s","endOffset":"14.600s","word":"▁걸","confidence":0.87048674},{"startOffset":"14.600s","endOffset":"14.800s","word":"로","confidence":0.86638325},{"startOffset":"14.800s","endOffset":"15s","word":"▁보여","confidence":0.87048674},{"startOffset":"15s","endOffset":"15.300s","word":"지","confidence":0.87048674},{"startOffset":"15.300s","endOffset":"15.300s","word":"고"},{"startOffset":"15.300s","endOffset":"15.500s","word":"요","confidence":0.73173845}]},{"transcript":" 지금 클로바 스피치가 아주 인식을 잘 하는 걸로 보여지고요","confidence":0.85760385}],"resultEndOffset":"16.250s","languageCode":"ko-kr"},{"alternatives":[{"transcript":"음 이런 잉여 단어를 많이 넣어서 얘기를 해야 되는데 인식을 하니까 더 안 나오는 느낌이다 예","confidence":0.870487,"words":[{"startOffset":"17s","endOffset":"17.300s","word":"▁","confidence":0.87048674},{"startOffset":"17.300s","endOffset":"17.300s","word":"음"},{"startOffset":"17.300s","endOffset":"18.100s","word":"▁이런","confidence":0.87048674},{"startOffset":"18.100s","endOffset":"18.900s","word":"▁","confidence":0.87048674},{"startOffset":"18.900s","endOffset":"19.100s","word":"잉","confidence":0.87048674},{"startOffset":"19.100s","endOffset":"19.200s","word":"여","confidence":0.87048674},{"startOffset":"19.200s","endOffset":"20s","word":"▁","confidence":0.87048674},{"startOffset":"20s","endOffset":"20s","word":"단"},{"startOffset":"20s","endOffset":"20.100s","word":"어","confidence":0.87048674},{"startOffset":"20.100s","endOffset":"20.100s","word":"를"},{"startOffset":"20.100s","endOffset":"21s","word":"▁많이","confidence":0.87048674},{"startOffset":"21s","endOffset":"21.400s","word":"▁","confidence":0.87048674},{"startOffset":"21.400s","endOffset":"21.400s","word":"넣"},{"startOffset":"21.400s","endOffset":"21.500s","word":"어","confidence":0.87048674},{"startOffset":"21.500s","endOffset":"21.500s","word":"서","confidence":0.87048674},{"startOffset":"21.500s","endOffset":"21.700s","word":"▁","confidence":0.87048674},{"startOffset":"21.700s","endOffset":"21.700s","word":"얘기"},{"startOffset":"21.700s","endOffset":"21.900s","word":"를","confidence":0.87048674},{"startOffset":"21.900s","endOffset":"22.200s","word":"▁","confidence":0.87048674},{"startOffset":"22.200s","endOffset":"22.200s","word":"해야"},{"startOffset":"22.200s","endOffset":"22.500s","word":"▁되","confidence":0.87048674},{"startOffset":"22.500s","endOffset":"22.500s","word":"는데"},{"startOffset":"22.500s","endOffset":"23.200s","word":"▁","confidence":0.87048674},{"startOffset":"23.200s","endOffset":"23.200s","word":"인"},{"startOffset":"23.200s","endOffset":"23.400s","word":"식","confidence":0.87048674},{"startOffset":"23.400s","endOffset":"23.400s","word":"을","confidence":0.87048674},{"startOffset":"23.400s","endOffset":"23.700s","word":"▁하","confidence":0.87048674},{"startOffset":"23.700s","endOffset":"23.800s","word":"니까","confidence":0.87048674},{"startOffset":"23.800s","endOffset":"24.400s","word":"▁더","confidence":0.87048674},{"startOffset":"24.400s","endOffset":"24.600s","word":"▁안","confidence":0.87048674},{"startOffset":"24.600s","endOffset":"24.800s","word":"▁나오","confidence":0.87048674},{"startOffset":"24.800s","endOffset":"25s","word":"는","confidence":0.87048674},{"startOffset":"25s","endOffset":"25.200s","word":"▁","confidence":0.87048674},{"startOffset":"25.200s","endOffset":"25.200s","word":"느낌"},{"startOffset":"25.200s","endOffset":"25.500s","word":"이","confidence":0.87048674},{"startOffset":"25.500s","endOffset":"25.600s","word":"다","confidence":0.87048674},{"startOffset":"25.600s","endOffset":"26.300s","word":"▁예","confidence":0.87048674}]},{"transcript":"음 이런 잉여 단어를 많이 넣어서 얘기를 해야 되는데 인식을 하니까 더 안 나오는 느낌이","confidence":0.870487}],"resultEndOffset":"27.080s","languageCode":"ko-kr"},{"alternatives":[{"transcript":"라는 생각이 들고","confidence":0.87048674,"words":[{"startOffset":"27.700s","endOffset":"28.200s","word":"▁","confidence":0.87048674},{"startOffset":"28.200s","endOffset":"28.300s","word":"라는","confidence":0.87048674},{"startOffset":"28.300s","endOffset":"28.500s","word":"▁생각","confidence":0.87048674},{"startOffset":"28.500s","endOffset":"28.800s","word":"이","confidence":0.87048674},{"startOffset":"28.800s","endOffset":"29s","word":"▁","confidence":0.87048674},{"startOffset":"29s","endOffset":"29.100s","word":"들","confidence":0.87048674},{"startOffset":"29.100s","endOffset":"29.100s","word":"고"}]},{"transcript":"라는 생각에 들고","confidence":0.93524337}],"resultEndOffset":"29.770s","languageCode":"ko-kr"},{"alternatives":[{"transcript":" 아 맞다 그 지금 이거 그 긴 문장으로 김 문장으로 API 그거를 설정을 해 가지고 60초 이상 전용으로 한 거라서 이게 60초 이상으로 인풋을 해야 될지 아니면 60초 이하여도 괜찮을지 모르겠지만 일단","confidence":0.8681491,"words":[{"startOffset":"31.100s","endOffset":"31.500s","word":"▁아","confidence":0.87048674},{"startOffset":"31.500s","endOffset":"31.700s","word":"▁","confidence":0.87048674},{"startOffset":"31.700s","endOffset":"31.700s","word":"맞"},{"startOffset":"31.700s","endOffset":"31.700s","word":"다"},{"startOffset":"31.700s","endOffset":"31.900s","word":"▁그","confidence":0.87048674},{"startOffset":"31.900s","endOffset":"32.600s","word":"▁지금","confidence":0.87048674},{"startOffset":"32.600s","endOffset":"32.900s","word":"▁이거","confidence":0.87048674},{"startOffset":"32.900s","endOffset":"33.100s","word":"▁그","confidence":0.87048674},{"startOffset":"33.100s","endOffset":"33.600s","word":"▁","confidence":0.87048674},{"startOffset":"33.600s","endOffset":"33.800s","word":"긴","confidence":0.87048674},{"startOffset":"33.800s","endOffset":"33.900s","word":"▁","confidence":0.87048674},{"startOffset":"33.900s","endOffset":"33.900s","word":"문"},{"startOffset":"33.900s","endOffset":"33.900s","word":"장","confidence":0.87048674},{"startOffset":"33.900s","endOffset":"34.100s","word":"으로","confidence":0.87048674},{"startOffset":"34.100s","endOffset":"35.300s","word":"▁김","confidence":0.87048674},{"startOffset":"35.300s","endOffset":"35.400s","word":"▁","confidence":0.87048674},{"startOffset":"35.400s","endOffset":"35.400s","word":"문"},{"startOffset":"35.400s","endOffset":"35.500s","word":"장","confidence":0.87048674},{"startOffset":"35.500s","endOffset":"35.600s","word":"으로","confidence":0.87048674},{"startOffset":"35.600s","endOffset":"36.500s","word":"▁","confidence":0.87048674},{"startOffset":"36.500s","endOffset":"36.500s","word":"a"},{"startOffset":"36.500s","endOffset":"36.700s","word":"p","confidence":0.87048674},{"startOffset":"36.700s","endOffset":"36.800s","word":"i","confidence":0.87048674},{"startOffset":"36.800s","endOffset":"37.100s","word":"▁그거","confidence":0.87048674},{"startOffset":"37.100s","endOffset":"37.100s","word":"를","confidence":0.87048674},{"startOffset":"37.100s","endOffset":"37.300s","word":"▁설","confidence":0.87048674},{"startOffset":"37.300s","endOffset":"37.400s","word":"정","confidence":0.87048674},{"startOffset":"37.400s","endOffset":"37.500s","word":"을","confidence":0.87048674},{"startOffset":"37.500s","endOffset":"37.700s","word":"▁해","confidence":0.87048674},{"startOffset":"37.700s","endOffset":"37.700s","word":"▁","confidence":0.87048674},{"startOffset":"37.700s","endOffset":"37.700s","word":"가지고"},{"startOffset":"37.700s","endOffset":"38.300s","word":"▁","confidence":0.87048674},{"startOffset":"38.300s","endOffset":"38.400s","word":"6","confidence":0.87048674},{"startOffset":"38.400s","endOffset":"38.600s","word":"0","confidence":0.87048674},{"startOffset":"38.600s","endOffset":"38.700s","word":"초","confidence":0.87048674},{"startOffset":"38.700s","endOffset":"38.800s","word":"▁이","confidence":0.87048674},{"startOffset":"38.800s","endOffset":"38.900s","word":"상","confidence":0.87048674},{"startOffset":"38.900s","endOffset":"39.300s","word":"▁전","confidence":0.87048674},{"startOffset":"39.300s","endOffset":"39.400s","word":"용","confidence":0.87048674},{"startOffset":"39.400s","endOffset":"39.500s","word":"으로","confidence":0.87048674},{"startOffset":"39.500s","endOffset":"40s","word":"▁한","confidence":0.87048674},{"startOffset":"40s","endOffset":"40.100s","word":"▁거","confidence":0.87048674},{"startOffset":"40.100s","endOffset":"40.200s","word":"라","confidence":0.87048674},{"startOffset":"40.200s","endOffset":"40.200s","word":"서"},{"startOffset":"40.200s","endOffset":"42.100s","word":"▁이게","confidence":0.87048674},{"startOffset":"42.100s","endOffset":"42.700s","word":"▁","confidence":0.87048674},{"startOffset":"42.700s","endOffset":"42.800s","word":"6","confidence":0.87048674},{"startOffset":"42.800s","endOffset":"43s","word":"0","confidence":0.87048674},{"startOffset":"43s","endOffset":"43s","word":"초","confidence":0.87048674},{"startOffset":"43s","endOffset":"43.200s","word":"▁이","confidence":0.87048674},{"startOffset":"43.200s","endOffset":"43.400s","word":"상","confidence":0.87048674},{"startOffset":"43.400s","endOffset":"43.500s","word":"으로","confidence":0.87048674},{"startOffset":"43.500s","endOffset":"44s","word":"▁","confidence":0.87048674},{"startOffset":"44s","endOffset":"44.100s","word":"인","confidence":0.87048674},{"startOffset":"44.100s","endOffset":"44.300s","word":"풋","confidence":0.87048674},{"startOffset":"44.300s","endOffset":"44.300s","word":"을","confidence":0.87048674},{"startOffset":"44.300s","endOffset":"44.500s","word":"▁","confidence":0.87048674},{"startOffset":"44.500s","endOffset":"44.500s","word":"해야"},{"startOffset":"44.500s","endOffset":"44.600s","word":"▁","confidence":0.87048674},{"startOffset":"44.600s","endOffset":"44.600s","word":"될"},{"startOffset":"44.600s","endOffset":"44.800s","word":"지","confidence":0.87048674},{"startOffset":"44.800s","endOffset":"44.800s","word":"▁아니","confidence":0.87048674},{"startOffset":"44.800s","endOffset":"44.900s","word":"면","confidence":0.87048674},{"startOffset":"44.900s","endOffset":"45s","word":"▁","confidence":0.87048674},{"startOffset":"45s","endOffset":"45.100s","word":"6","confidence":0.87048674},{"startOffset":"45.100s","endOffset":"45.200s","word":"0","confidence":0.87048674},{"startOffset":"45.200s","endOffset":"45.200s","word":"초","confidence":0.75826913},{"startOffset":"45.200s","endOffset":"45.500s","word":"▁이","confidence":0.87048674},{"startOffset":"45.500s","endOffset":"45.500s","word":"하","confidence":0.87048674},{"startOffset":"45.500s","endOffset":"45.600s","word":"여","confidence":0.87048674},{"startOffset":"45.600s","endOffset":"45.700s","word":"도","confidence":0.87048674},{"startOffset":"45.700s","endOffset":"45.800s","word":"▁","confidence":0.87048674},{"startOffset":"45.800s","endOffset":"45.800s","word":"괜찮","confidence":0.75826913},{"startOffset":"45.800s","endOffset":"46.100s","word":"을","confidence":0.87048674},{"startOffset":"46.100s","endOffset":"46.100s","word":"지","confidence":0.87048674},{"startOffset":"46.100s","endOffset":"46.400s","word":"▁모르겠","confidence":0.87048674},{"startOffset":"46.400s","endOffset":"46.600s","word":"지만","confidence":0.87048674},{"startOffset":"46.600s","endOffset":"47.600s","word":"▁일단","confidence":0.87048674}]},{"transcript":" 아 맞다 그 지금 이거 그 긴 문장으로 김 문장으로 API 그거를 설정을 해 가지고 60초 이상 전용으로 한 거라서 이게 60초 이상으로 인풋을 해야 될지 아니면 60표 이하여도 괜찮을지 모르겠지만 일단","confidence":0.86954427}],"resultEndOffset":"48.280s","languageCode":"ko-kr"},{"alternatives":[{"transcript":" 50초 50초가 지나가고 있고요 아 한마디 해주시죠 감사합니다","confidence":0.8511021,"words":[{"startOffset":"49.800s","endOffset":"51s","word":"▁","confidence":0.87048674},{"startOffset":"51s","endOffset":"51s","word":"50"},{"startOffset":"51s","endOffset":"51.200s","word":"초","confidence":0.87048674},{"startOffset":"51.200s","endOffset":"51.400s","word":"▁","confidence":0.87048674},{"startOffset":"51.400s","endOffset":"51.500s","word":"50","confidence":0.87048674},{"startOffset":"51.500s","endOffset":"51.700s","word":"초","confidence":0.87048674},{"startOffset":"51.700s","endOffset":"51.800s","word":"가","confidence":0.87048674},{"startOffset":"51.800s","endOffset":"52s","word":"▁","confidence":0.87048674},{"startOffset":"52s","endOffset":"52s","word":"지"},{"startOffset":"52s","endOffset":"52.100s","word":"나","confidence":0.87048674},{"startOffset":"52.100s","endOffset":"52.100s","word":"가","confidence":0.87048674},{"startOffset":"52.100s","endOffset":"52.200s","word":"고","confidence":0.87048674},{"startOffset":"52.200s","endOffset":"52.200s","word":"▁있고","confidence":0.87048674},{"startOffset":"52.200s","endOffset":"52.200s","word":"요"},{"startOffset":"52.200s","endOffset":"52.700s","word":"▁아","confidence":0.87048674},{"startOffset":"52.700s","endOffset":"53s","word":"▁한","confidence":0.87048674},{"startOffset":"53s","endOffset":"53.100s","word":"마","confidence":0.87048674},{"startOffset":"53.100s","endOffset":"53.200s","word":"디","confidence":0.87048674},{"startOffset":"53.200s","endOffset":"53.300s","word":"▁해","confidence":0.87048674},{"startOffset":"53.300s","endOffset":"53.400s","word":"주","confidence":0.7125154},{"startOffset":"53.400s","endOffset":"53.400s","word":"시","confidence":0.87048674},{"startOffset":"53.400s","endOffset":"53.400s","word":"죠"},{"startOffset":"53.400s","endOffset":"54.500s","word":"▁","confidence":0.87048674},{"startOffset":"54.500s","endOffset":"54.600s","word":"감사합니다","confidence":0.7680668}]},{"transcript":" 50초 50초가 지나가고 있고요 아 한마디 해 주시죠 감사합니다","confidence":0.8600397}],"resultEndOffset":"55.350s","languageCode":"ko-kr"},{"alternatives":[{"transcript":" 즐겁습니다","confidence":0.8402766,"words":[{"startOffset":"56.500s","endOffset":"57s","word":"▁","confidence":0.84027654},{"startOffset":"57s","endOffset":"57s","word":"즐"},{"startOffset":"57s","endOffset":"57.100s","word":"겁","confidence":0.8402766},{"startOffset":"57.100s","endOffset":"57.100s","word":"습니다"}]}],"resultEndOffset":"57.840s","languageCode":"ko-kr"},{"alternatives":[{"transcript":" 예 자 1분 끝","confidence":0.77993643,"words":[{"startOffset":"58.700s","endOffset":"58.900s","word":"▁예","confidence":0.87048674},{"startOffset":"58.900s","endOffset":"60.100s","word":"▁자","confidence":0.87048674},{"startOffset":"60.100s","endOffset":"60.500s","word":"▁1","confidence":0.6893861},{"startOffset":"60.500s","endOffset":"60.600s","word":"분","confidence":0.68938607},{"startOffset":"60.600s","endOffset":"60.800s","word":"▁","confidence":0.8398595},{"startOffset":"60.800s","endOffset":"60.800s","word":"끝"}]},{"transcript":" 예 자 일본 끝","confidence":0.77605367}],"resultEndOffset":"61.280s","languageCode":"ko-kr"}]}


def stt_results_to_sentences(stt: dict):
  sentences = []
  for result in stt.get("results", []):
    alts = result.get("alternatives") or []
    if not alts:
      continue
    sent = (alts[0].get("transcript") or "").strip()
    if sent:
      sentences.append(sent)
  return sentences


def encode_text(texts):
  return tokenizer(
    texts,
    padding=True,
    truncation=True,
    return_tensors="pt",
  )


def bert_predict_sentence(sentence):
  token = encode_text([sentence])
  token = {k: v.to(device) for k, v in token.items()}

  with torch.no_grad():
    logits = model(**token).logits
    probs = torch.sigmoid(logits).cpu().numpy()[0]
    pred = (probs > 0.5).astype(int)
  return pred


def convert_results_to_json(sentences, preds):
  out = []
  for sent, pred in zip(sentences, preds):
    result = {
      "sentence": sent,
      "classification": {}
    }
    for i, lab in enumerate(label_names):
      result["classification"][lab] = int(pred[i])
    out.append(result)
  return out


sentences = stt_results_to_sentences(stt_result)

all_preds = []
for sent in sentences:
  all_preds.append(bert_predict_sentence(sent))
all_preds = np.array(all_preds)

json_output = convert_results_to_json(sentences, all_preds)
print(json.dumps(json_output, ensure_ascii=False, indent=2))

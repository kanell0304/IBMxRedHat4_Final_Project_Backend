# AI 모델 백엔드 배포 가이드

## 설정 완료 사항 ✅

### 1. CORS 설정
- **로컬**: http://localhost:5173, http://127.0.0.1:5173
- **프로덕션**: https://d3b6lthi00ti95.cloudfront.net

### 2. CI/CD 설정
- **배포 브랜치**: main (develop에서 merge 후 배포)
- **자동 배포**: main 브랜치 push 시 자동 실행

### 3. 인스턴스 설정
- **타입**: t3.large (vCPU 2, 메모리 8GB)
- **Swap 메모리**: 8GB 추가 설정 → 총 16GB
- **비용**: 약 $60/월

## GitHub Secrets 설정

TeamProjectBackend 저장소에 다음 Secrets를 추가하세요:

### 필수 Secrets

```bash
# CORS 설정
ALLOWED_ORIGINS=http://localhost:5173,http://127.0.0.1:5173,https://d3b6lthi00ti95.cloudfront.net

# AWS 자격 증명 (이미 있을 수 있음)
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key

# S3 모델 버킷 (이미 있을 수 있음)
S3_MODEL_BUCKET=team2-backend-wav2vec-pkl

# 데이터베이스 설정
DB_HOST=your-rds-endpoint.ap-northeast-2.rds.amazonaws.com
DB_PORT=3306
DB_NAME=final_project_db
DB_USER=root
DB_PASSWORD=your_db_password

# EC2 SSH 설정
EC2_HOST=your-ec2-public-ip
EC2_USER=ubuntu  # 또는 ec2-user (AMI에 따라)
EC2_SSH_KEY=your_private_ssh_key_content
```

## EC2 Swap 메모리 설정

이전에 설정했던 방법대로 EC2에 Swap 메모리를 추가합니다.

### EC2 인스턴스 최초 설정 시

```bash
# 1. EC2에 SSH 접속
ssh -i your-key.pem ubuntu@your-ec2-ip

# 2. Swap 파일 생성 (8GB)
sudo fallocate -l 8G /swapfile

# 3. 권한 설정
sudo chmod 600 /swapfile

# 4. Swap 영역 설정
sudo mkswap /swapfile

# 5. Swap 활성화
sudo swapon /swapfile

# 6. 재부팅 후에도 유지되도록 설정
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab

# 7. Swap 확인
free -h
```

출력 예시:
```
              total        used        free      shared  buff/cache   available
Mem:           7.6G        2.0G        4.0G        10M        1.6G        5.3G
Swap:          8.0G          0B        8.0G  ← 8GB 추가 확인
```

### Swap 성능 최적화 (선택사항)

```bash
# Swappiness 설정 (메모리가 얼마나 차면 swap 사용할지)
# 기본값 60 → 10으로 낮춤 (RAM 우선 사용)
sudo sysctl vm.swappiness=10
echo 'vm.swappiness=10' | sudo tee -a /etc/sysctl.conf
```

## 배포 전 체크리스트

### 1. GitHub Secrets 확인
- [ ] `ALLOWED_ORIGINS` 추가
- [ ] `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASSWORD` 추가
- [ ] `EC2_HOST`, `EC2_USER`, `EC2_SSH_KEY` 추가
- [ ] `S3_MODEL_BUCKET` 확인 (이미 있을 수 있음)

### 2. EC2 인스턴스 준비
- [ ] t3.large 인스턴스 실행 중
- [ ] Swap 메모리 8GB 설정 완료
- [ ] 보안 그룹 8081 포트 오픈 (0.0.0.0/0 또는 필요한 IP만)
- [ ] Docker 설치 완료
- [ ] AWS CLI 설치 및 IAM 역할 설정

### 3. 데이터베이스 준비
- [ ] RDS 인스턴스 실행 중
- [ ] `final_project_db` 데이터베이스 생성
- [ ] EC2에서 RDS 접근 가능 (보안 그룹)

### 4. S3 모델 버킷 준비
- [ ] `team2-backend-wav2vec-pkl` 버킷 존재
- [ ] AI 모델 파일(.pkl) 업로드됨
- [ ] EC2 IAM 역할에 S3 읽기 권한 있음

## 배포 실행

### 1. develop 브랜치 → main 브랜치 merge

```bash
# 로컬에서
cd C:\IBMxRedHat4\TeamProjectBackend

# 현재 develop 브랜치 확인
git branch

# develop 브랜치의 최신 변경사항 커밋
git add .
git commit -m "feat: 개발 완료 - main 배포 준비"
git push origin develop

# main 브랜치로 전환
git checkout main
git pull origin main

# develop 브랜치 merge
git merge develop

# main 브랜치에 push → 자동 배포 시작!
git push origin main
```

### 2. GitHub Actions 배포 모니터링

1. GitHub 저장소 페이지 이동
2. **Actions** 탭 클릭
3. "Deploy to AWS" 워크플로우 실행 확인
4. 각 단계별 로그 확인:
   - ✅ Checkout code
   - ✅ Configure AWS credentials
   - ✅ Upload models to S3
   - ✅ Login to Amazon ECR
   - ✅ Build and push Docker image
   - ✅ Deploy to EC2

### 3. 배포 확인

```bash
# EC2 SSH 접속
ssh -i your-key.pem ubuntu@your-ec2-ip

# 컨테이너 실행 확인
docker ps

# 로그 확인
docker logs -f teamproject-backend

# 헬스 체크
curl http://localhost:8081/health
```

## 프론트엔드 연결

프론트엔드 환경 변수도 업데이트해야 합니다.

### TeamProjectFrontend GitHub Secrets 업데이트

```bash
# 현재
VITE_API_BASE_URL=http://localhost:8081

# 업데이트 (EC2 퍼블릭 IP 또는 도메인)
VITE_API_BASE_URL=http://your-ec2-ip:8081
# 또는 HTTPS 도메인 설정 시
VITE_API_BASE_URL=https://api.yourdomain.com
```

### 프론트엔드 재배포

```bash
cd C:\IBMxRedHat4\TeamProjectFrontend

# GitHub Secrets 업데이트 후
git add .
git commit -m "chore: 프로덕션 API URL 업데이트" --allow-empty
git push origin main
```

## 성능 모니터링

### EC2 리소스 확인

```bash
# CPU, 메모리 사용량 실시간 모니터링
htop

# 메모리 사용량 확인
free -h

# Swap 사용량 확인
swapon --show

# Docker 컨테이너 리소스 확인
docker stats
```

### 모델 로딩 시간 확인

```bash
# 컨테이너 로그에서 모델 로딩 시간 확인
docker logs teamproject-backend | grep "모델"
```

## 트러블슈팅

### Out of Memory (OOM) 에러 발생 시

```bash
# Swap 사용량 확인
free -h

# Swap이 부족하면 추가 (4GB → 8GB)
sudo swapoff /swapfile
sudo rm /swapfile
sudo fallocate -l 12G /swapfile  # 12GB로 증가
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

### Docker 빌드 실패 시

```bash
# EC2 SSH 접속 후
docker system prune -a  # 모든 이미지 삭제
docker pull your-ecr-url/teamproject-backend:latest
```

### CORS 에러 발생 시

```bash
# 컨테이너 환경 변수 확인
docker exec teamproject-backend env | grep ALLOWED_ORIGINS

# 출력되어야 할 값:
# ALLOWED_ORIGINS=http://localhost:5173,http://127.0.0.1:5173,https://d3b6lthi00ti95.cloudfront.net
```

## 비용 예상

### 월간 비용 (750달러 크레딧 사용)

- **EC2 t3.large**: $60/월
- **RDS**: $15-30/월 (db.t3.micro 기준)
- **S3**: $1-5/월 (모델 파일)
- **ECR**: $1/월
- **네트워크**: $5-10/월
- **총 예상**: $82-106/월

**700달러로 약 7-9개월 운영 가능**

## 다음 단계

1. **GitHub Secrets 설정** (가장 중요!)
2. **EC2 Swap 메모리 설정** (이미 했다면 skip)
3. **develop → main merge & push**
4. **배포 모니터링**
5. **프론트엔드 API URL 업데이트**

---

**준비되었나요?** 
- EC2 퍼블릭 IP 주소를 알려주시면 정확한 설정값을 제공하겠습니다.
- RDS 엔드포인트도 알려주시면 도와드리겠습니다.
